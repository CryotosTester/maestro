name: Linux Android Emulator + Maestro Tests (Fast)

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  android-maestro:
    runs-on: ubuntu-latest
    timeout-minutes: 45

    env:
      AVD_NAME: Pixel_6_Pro
      ANDROID_API_LEVEL: 34
      ANDROID_SDK_ROOT: /usr/local/lib/android/sdk
      ANDROID_HOME: /usr/local/lib/android/sdk

    steps:
      # 1Ô∏è‚É£ Checkout
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2Ô∏è‚É£ Java 17 (required for modern Android SDK)
      - name: Set up Java
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 17

      # 3Ô∏è‚É£ Enable KVM (critical for speed)
      - name: Enable KVM
        run: |
          sudo apt-get update
          sudo apt-get install -y qemu-kvm libvirt-daemon-system libvirt-clients bridge-utils
          sudo chmod 666 /dev/kvm

      # 4Ô∏è‚É£ Install Android SDK + Emulator
      - name: Install Android SDK
        run: |
          sudo mkdir -p $ANDROID_SDK_ROOT
          sudo chown -R $USER:$USER $ANDROID_SDK_ROOT

          curl -sS https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip -o cmdline-tools.zip
          unzip -q cmdline-tools.zip
          mkdir -p $ANDROID_SDK_ROOT/cmdline-tools
          mv cmdline-tools $ANDROID_SDK_ROOT/cmdline-tools/latest

          export PATH=$ANDROID_SDK_ROOT/cmdline-tools/latest/bin:$ANDROID_SDK_ROOT/emulator:$ANDROID_SDK_ROOT/platform-tools:$PATH

          yes | sdkmanager --licenses

          sdkmanager \
            "platform-tools" \
            "emulator" \
            "platforms;android-${ANDROID_API_LEVEL}" \
            "system-images;android-${ANDROID_API_LEVEL};google_apis_playstore;x86_64"

      # 5Ô∏è‚É£ Create AVD (Pixel 6 Pro)
      - name: Create AVD
        run: |
          export PATH=$ANDROID_SDK_ROOT/cmdline-tools/latest/bin:$ANDROID_SDK_ROOT/emulator:$ANDROID_SDK_ROOT/platform-tools:$PATH

          avdmanager create avd \
            --name $AVD_NAME \
            --package "system-images;android-${ANDROID_API_LEVEL};google_apis_playstore;x86_64" \
            --device pixel_6_pro \
            --force

      # 6Ô∏è‚É£ Start Emulator (FAST FLAGS)
      - name: Start Emulator
        run: |
          export PATH=$ANDROID_SDK_ROOT/emulator:$ANDROID_SDK_ROOT/platform-tools:$PATH

          emulator -avd $AVD_NAME \
            -no-window \
            -no-audio \
            -gpu swiftshader_indirect \
            -no-boot-anim \
            -memory 4096 \
            -partition-size 4096 \
            -netdelay none \
            -netspeed full &

          adb wait-for-device
          adb shell 'while [[ -z $(getprop sys.boot_completed) ]]; do sleep 1; done'
          adb shell input keyevent 82

      # 7Ô∏è‚É£ Install Maestro
      - name: Install Maestro
        run: |
          curl -Ls https://get.maestro.mobile.dev | bash
          echo "$HOME/.maestro/bin" >> $GITHUB_PATH

      # 8Ô∏è‚É£ Run Maestro tests
      - name: Run Maestro Tests
        run: |
          adb install -r app/build/outputs/apk/debug/app-debug.apk
          maestro test .

      # 9Ô∏è‚É£ Upload Maestro screenshots
      - name: Upload Maestro screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: maestro-screenshots
          path: /home/runner/.maestro/screenshots

      # üîü Shutdown emulator
      - name: Stop Emulator
        if: always()
        run: |
          adb emu kill || true
