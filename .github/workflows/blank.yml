name: Windows Android Emulator + Maestro Tests

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  run_android_emulator:
    runs-on: windows-latest
    timeout-minutes: 60

    env:
      AVD_NAME: Pixel_8
      ANDROID_API_LEVEL: 36
      ANDROID_SDK_ROOT: ${{ runner.temp }}\android-sdk

    steps:
      # Step 1: Checkout code
      - name: Checkout repository
        uses: actions/checkout@v3

      # Step 2: Setup Java
      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 11

      # Step 3: Install Android SDK command-line tools + emulator
      - name: Install Android SDK & System Images
        shell: pwsh
        run: |
          mkdir -Force $Env:ANDROID_SDK_ROOT\cmdline-tools
          Invoke-WebRequest https://dl.google.com/android/repository/commandlinetools-win-9477386_latest.zip -OutFile cmdline-tools.zip
          Expand-Archive cmdline-tools.zip -DestinationPath $Env:ANDROID_SDK_ROOT\cmdline-tools
          Rename-Item $Env:ANDROID_SDK_ROOT\cmdline-tools\cmdline-tools $Env:ANDROID_SDK_ROOT\cmdline-tools\latest

          # Update PATH for this step
          $Env:PATH="$Env:ANDROID_SDK_ROOT\cmdline-tools\latest;$Env:ANDROID_SDK_ROOT\emulator;$Env:ANDROID_SDK_ROOT\platform-tools;$Env:PATH"

          # Accept licenses
          yes | sdkmanager.bat --licenses

          # Install required packages
          sdkmanager.bat "platform-tools" "emulator" "platforms;android-${Env:ANDROID_API_LEVEL}" "system-images;android-${Env:ANDROID_API_LEVEL};google_apis_playstore;x86_64"

      # Step 4: Create and start emulator
      - name: Create and launch emulator
        shell: pwsh
        run: |
          $Env:PATH="$Env:ANDROID_SDK_ROOT\cmdline-tools\latest;$Env:ANDROID_SDK_ROOT\emulator;$Env:ANDROID_SDK_ROOT\platform-tools;$Env:PATH"
          avdmanager.bat create avd -n "$Env:AVD_NAME" -k "system-images;android-${Env:ANDROID_API_LEVEL};google_apis_playstore;x86_64" --force

          # Start emulator in background
          Start-Process -NoNewWindow -FilePath "$Env:ANDROID_SDK_ROOT\emulator\emulator.exe" -ArgumentList "-avd $Env:AVD_NAME -no-window -no-audio -gpu host -accel on"

          # Wait for device boot
          do {
            Start-Sleep -Seconds 5
            $bootCompleted = adb shell getprop sys.boot_completed 2>$null
          } while ($bootCompleted -ne "1")

          adb shell input keyevent 82

      # Step 5: Install Maestro CLI
      - name: Install Maestro CLI
        run: iex ((New-Object System.Net.WebClient).DownloadString('https://get.maestro.mobile.dev'))

      # Step 6: Install APK & Run Maestro tests
      - name: Install APK & Run Maestro
        shell: pwsh
        run: |
          adb install -r .\app\build\outputs\apk\debug\app-debug.apk
          .\scripts\run_maestro_simple.ps1

      # Step 7: Stop emulator
      - name: Shutdown emulator
        if: always()
        shell: pwsh
        run: adb emu kill
