name: Windows Android Emulator + Maestro Tests

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  run_android_emulator:
    runs-on: windows-latest
    timeout-minutes: 60

    env:
      AVD_NAME: Pixel_8
      ANDROID_API_LEVEL: 33
      ANDROID_SDK_ROOT: ${{ runner.temp }}/android-sdk

    steps:
      # Step 1: Checkout code
      - name: Checkout repository
        uses: actions/checkout@v3

      # Step 2: Setup JDK
      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 11

      # Step 3: Install Android SDK command-line tools + emulator
      - name: Install Android SDK & System Images
        shell: bash
        run: |
          mkdir -p "$ANDROID_SDK_ROOT/cmdline-tools"
          curl -o cmdline-tools.zip https://dl.google.com/android/repository/commandlinetools-win-9477386_latest.zip
          unzip -q cmdline-tools.zip -d "$ANDROID_SDK_ROOT/cmdline-tools"
          mv "$ANDROID_SDK_ROOT/cmdline-tools/cmdline-tools" "$ANDROID_SDK_ROOT/cmdline-tools/latest"
          
          export PATH="$ANDROID_SDK_ROOT/cmdline-tools/latest/bin:$ANDROID_SDK_ROOT/platform-tools:$ANDROID_SDK_ROOT/emulator:$PATH"

          yes | sdkmanager --sdk_root=$ANDROID_SDK_ROOT --licenses
          sdkmanager --sdk_root=$ANDROID_SDK_ROOT "platform-tools" "emulator" "platforms;android-${ANDROID_API_LEVEL}" "system-images;android-${ANDROID_API_LEVEL};google_apis_playstore;x86_64"

      # Step 4: Create and start emulator
      - name: Create and launch emulator
        shell: bash
        run: |
          export PATH="$ANDROID_SDK_ROOT/cmdline-tools/latest/bin:$ANDROID_SDK_ROOT/emulator:$ANDROID_SDK_ROOT/platform-tools:$PATH"
          avdmanager create avd -n "$AVD_NAME" -k "system-images;android-${ANDROID_API_LEVEL};google_apis_playstore;x86_64" --force
          
          # Boot emulator with WHPX acceleration
          emulator -avd "$AVD_NAME" -no-window -no-audio -gpu host -accel on &
          
          adb wait-for-device
          
          # Wait for full boot
          BOOT_COMPLETED=""
          while [ "$BOOT_COMPLETED" != "1" ]; do
            sleep 5
            BOOT_COMPLETED=$(adb shell getprop sys.boot_completed | tr -d '\r')
          done
          
          adb shell input keyevent 82

      # Step 5: Install Maestro CLI
      - name: Install Maestro CLI
        run: curl -Ls https://get.maestro.mobile.dev | bash

      # Step 6: Install APK and run Maestro tests
      - name: Install APK & Run Maestro
        shell: bash
        run: |
          adb install -r app/build/outputs/apk/debug/app-debug.apk
          ./scripts/run_maestro_simple.sh

      # Step 7: Stop emulator
      - name: Shutdown emulator
        if: always()
        shell: bash
        run: adb emu kill
