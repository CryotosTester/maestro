name: Android Emulator + Maestro (CI)

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  android-maestro:
    runs-on: ubuntu-latest
    timeout-minutes: 45

    env:
      AVD_NAME: Pixel_6_Pro
      ANDROID_API_LEVEL: 34
      ANDROID_SDK_ROOT: /usr/local/lib/android/sdk
      ANDROID_HOME: /usr/local/lib/android/sdk
      ANDROID_AVD_HOME: /home/runner/.android/avd

    steps:
      # 1Ô∏è‚É£ Checkout
      - name: Checkout repo
        uses: actions/checkout@v3

      # 2Ô∏è‚É£ Java 17
      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 17

      # 3Ô∏è‚É£ Enable KVM
      - name: Enable KVM
        run: |
          sudo apt-get update
          sudo apt-get install -y qemu-kvm libvirt-daemon-system libvirt-clients bridge-utils
          sudo chmod 666 /dev/kvm

      # 4Ô∏è‚É£ Install Android SDK
      - name: Install Android SDK
        run: |
          sudo mkdir -p $ANDROID_SDK_ROOT
          sudo chown -R $USER:$USER $ANDROID_SDK_ROOT

          curl -sS https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip -o cmdline-tools.zip
          unzip -q cmdline-tools.zip
          mkdir -p $ANDROID_SDK_ROOT/cmdline-tools
          mv cmdline-tools $ANDROID_SDK_ROOT/cmdline-tools/latest

          export PATH=$ANDROID_SDK_ROOT/cmdline-tools/latest/bin:$ANDROID_SDK_ROOT/emulator:$ANDROID_SDK_ROOT/platform-tools:$PATH
          yes | sdkmanager --licenses

          sdkmanager \
            "platform-tools" \
            "emulator" \
            "platforms;android-${ANDROID_API_LEVEL}" \
            "system-images;android-${ANDROID_API_LEVEL};google_apis_playstore;x86_64"

      # 5Ô∏è‚É£ Persist PATH (CRITICAL)
      - name: Add Android tools to PATH
        run: |
          echo "$ANDROID_SDK_ROOT/platform-tools" >> $GITHUB_PATH
          echo "$ANDROID_SDK_ROOT/emulator" >> $GITHUB_PATH
          echo "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin" >> $GITHUB_PATH

      # 6Ô∏è‚É£ Create AVD
      - name: Create AVD
        run: |
          mkdir -p $ANDROID_AVD_HOME

          avdmanager create avd \
            --name "$AVD_NAME" \
            --package "system-images;android-${ANDROID_API_LEVEL};google_apis_playstore;x86_64" \
            --device pixel_6_pro \
            --force

          emulator -list-avds

      # 7Ô∏è‚É£ Start Emulator (HARDENED)
      - name: Start Emulator
        run: |
          emulator -avd "$AVD_NAME" \
            -no-window \
            -no-audio \
            -gpu swiftshader_indirect \
            -no-boot-anim \
            -memory 4096 \
            -partition-size 4096 \
            -netdelay none \
            -netspeed full \
            -skip-adb-auth \
            -read-only &

          echo "Waiting for emulator..."

          BOOT_TIMEOUT=180
          START_TIME=$(date +%s)

          adb wait-for-device

          while true; do
            BOOT_COMPLETED=$(adb shell getprop sys.boot_completed 2>/dev/null | tr -d '\r')
            BOOT_ANIM=$(adb shell getprop init.svc.bootanim 2>/dev/null | tr -d '\r')

            if [[ "$BOOT_COMPLETED" == "1" && "$BOOT_ANIM" == "stopped" ]]; then
              echo "‚úÖ Emulator ready"
              break
            fi

            if (( $(date +%s) - START_TIME > BOOT_TIMEOUT )); then
              echo "‚ùå Emulator boot timeout"
              adb devices
              exit 1
            fi

            sleep 5
          done

          adb shell input keyevent 82

      # 8Ô∏è‚É£ Verify adb
      - name: Verify adb & device
        run: |
          adb version
          adb devices

      # 9Ô∏è‚É£ Install Maestro
      - name: Install Maestro
        run: |
          curl -Ls https://get.maestro.mobile.dev | bash
          echo "$HOME/.maestro/bin" >> $GITHUB_PATH

      # üîü Install APK + Run Maestro
      - name: Install APK & Run Maestro
        run: |
          adb install -r app/build/outputs/apk/debug/app-debug.apk
          maestro test .

      # 1Ô∏è‚É£1Ô∏è‚É£ Upload APK (PRIVATE)
      - name: Upload APK
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: app-debug-apk
          path: app/build/outputs/apk/debug/app-debug.apk
          retention-days: 14

      # 1Ô∏è‚É£2Ô∏è‚É£ Upload Maestro Screenshots
      - name: Upload Maestro screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: maestro-screenshots
          path: /home/runner/.maestro/screenshots

      # 1Ô∏è‚É£3Ô∏è‚É£ Stop Emulator
      - name: Stop Emulator
        if: always()
        run: adb emu kill || true
